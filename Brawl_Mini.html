<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Brawl Mini</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #1a1a1a;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  canvas {
    background: #2e2e2e;
    touch-action: none;
    border-radius: 10px;
  }
  #ui {
    position: absolute;
    top: 10px;
    left: 10px;
    color: white;
    font-family: "Pretendard", sans-serif;
    font-size: 1.1rem;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui">â¤ï¸ HP: <span id="hp">100</span></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  generateWalls(); // í™”ë©´ ë°”ë€Œë©´ ë§µ ìƒˆë¡œ ìƒì„±
}
window.addEventListener("resize", resize);
resize();

const player = { x: 0, y: 0, size: 22, color:"#4f8cff", hp:100, bullets:[], canShoot:true };
const enemy = { x: 0, y: 0, size: 22, color:"#ff4f4f", hp:50, alive:true, dirX:1, dirY:1, bullets:[] };
let fireCooldown = 0;

// === ëœë¤ ë§µ ìƒì„± ===
let walls = [];
function generateWalls() {
  walls = [];
  const w = canvas.width, h = canvas.height;
  const wallCount = Math.floor((w * h) / 90000); // í™”ë©´ í¬ê¸°ì— ë¹„ë¡€í•œ ë²½ ê°œìˆ˜
  for (let i = 0; i < wallCount; i++) {
    const ww = Math.random() * (w * 0.15) + 50;
    const hh = 20 + Math.random() * 40;
    const wx = Math.random() * (w - ww);
    const wy = Math.random() * (h - hh);
    walls.push({x: wx, y: wy, width: ww, height: hh});
  }

  // í”Œë ˆì´ì–´ / ì  ì´ˆê¸° ìœ„ì¹˜ëŠ” ë²½ê³¼ ê²¹ì¹˜ì§€ ì•Šê²Œ ì„¤ì •
  player.x = w * 0.5;
  player.y = h * 0.7;
  enemy.x = w * 0.5;
  enemy.y = h * 0.3;
}
generateWalls();

// ===== ì¡°ì´ìŠ¤í‹± ìƒíƒœ =====
let moveStick = null;
let fireStick = null;
let moveDir = {x:0,y:0};
let aimDir = {x:0,y:0};

// ===== í„°ì¹˜ ì¡°ì‘ =====
canvas.addEventListener("touchstart", e=>{
  for(const t of e.touches){
    if(t.clientX < window.innerWidth/2){
      moveStick = {id:t.identifier, sx:t.clientX, sy:t.clientY, x:t.clientX, y:t.clientY};
    } else {
      fireStick = {id:t.identifier, sx:t.clientX, sy:t.clientY, x:t.clientX, y:t.clientY};
    }
  }
});
canvas.addEventListener("touchmove", e=>{
  for(const t of e.touches){
    if(moveStick && t.identifier === moveStick.id){
      const dx=t.clientX-moveStick.sx, dy=t.clientY-moveStick.sy;
      const dist=Math.hypot(dx,dy), limit=50, r=Math.min(1,limit/dist);
      moveStick.x=moveStick.sx+dx*r; moveStick.y=moveStick.sy+dy*r;
      moveDir={x:dx/limit, y:dy/limit};
    }
    if(fireStick && t.identifier === fireStick.id){
      const dx=t.clientX-fireStick.sx, dy=t.clientY-fireStick.sy;
      const dist=Math.hypot(dx,dy), limit=50, r=Math.min(1,limit/dist);
      fireStick.x=fireStick.sx+dx*r; fireStick.y=fireStick.sy+dy*r;
      aimDir={x:dx/limit, y:dy/limit};
    }
  }
});
canvas.addEventListener("touchend", e=>{
  for(const t of e.changedTouches){
    if(moveStick && t.identifier === moveStick.id){
      moveStick=null; moveDir={x:0,y:0};
    }
    if(fireStick && t.identifier === fireStick.id){
      if(fireCooldown<=0 && (Math.abs(aimDir.x)>0.2||Math.abs(aimDir.y)>0.2)){
        shoot(aimDir.x,aimDir.y);
        fireCooldown=20;
      }
      fireStick=null; aimDir={x:0,y:0};
    }
  }
});

// ===== ë°œì‚¬ =====
function shoot(dx,dy){
  const angle=Math.atan2(dy,dx);
  player.bullets.push({x:player.x,y:player.y,dx:Math.cos(angle)*8,dy:Math.sin(angle)*8});
}

// ===== ì  AI =====
setInterval(()=>{
  if(!enemy.alive)return;
  const dx=player.x-enemy.x, dy=player.y-enemy.y, a=Math.atan2(dy,dx);
  enemy.bullets.push({x:enemy.x,y:enemy.y,dx:Math.cos(a)*4,dy:Math.sin(a)*4});
},1300);

// ===== ì¶©ëŒ ê´€ë ¨ =====
function handleWalls(o){
  for(const w of walls){
    if(o.x+o.size>w.x && o.x-o.size<w.x+w.width && o.y+o.size>w.y && o.y-o.size<w.y+w.height){
      // Xë°©í–¥ ì¶©ëŒ
      if(o.x<w.x) o.x=w.x-o.size;
      else if(o.x>w.x+w.width) o.x=w.x+w.width+o.size;
      // Yë°©í–¥ ì¶©ëŒ
      if(o.y<w.y) o.y=w.y-o.size;
      else if(o.y>w.y+w.height) o.y=w.y+w.height+o.size;
    }
  }
}

// ===== ê²Œì„ ë£¨í”„ =====
function update(){
  const speed=Math.max(canvas.width,canvas.height)*0.004;
  player.x+=moveDir.x*speed*5;
  player.y+=moveDir.y*speed*5;
  fireCooldown=Math.max(0,fireCooldown-1);

  if(enemy.alive){
    if(Math.random()<0.02) enemy.dirX*=-1;
    if(Math.random()<0.02) enemy.dirY*=-1;
    enemy.x+=enemy.dirX*2;
    enemy.y+=enemy.dirY*2;
  }

  handleWalls(player);
  handleWalls(enemy);
  moveBullets(player.bullets);
  moveBullets(enemy.bullets);
  checkHits();
  draw();
  requestAnimationFrame(update);
}

function moveBullets(bul){
  for(let i=bul.length-1;i>=0;i--){
    const b=bul[i];
    b.x+=b.dx; b.y+=b.dy;
    let hitWall=false;
    for(const w of walls){
      if(b.x>w.x && b.x<w.x+w.width && b.y>w.y && b.y<w.y+w.height){
        hitWall=true; break;
      }
    }
    if(hitWall||b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height){
      bul.splice(i,1);
    }
  }
}

function checkHits(){
  for(let i=player.bullets.length-1;i>=0;i--){
    const b=player.bullets[i];
    if(enemy.alive && dist(b.x,b.y,enemy.x,enemy.y)<enemy.size){
      player.bullets.splice(i,1);
      enemy.hp-=10;
      if(enemy.hp<=0){
        enemy.alive=false;
        setTimeout(()=>alert("ğŸ‰ ìŠ¹ë¦¬!"),100);
      }
    }
  }
  for(let i=enemy.bullets.length-1;i>=0;i--){
    const b=enemy.bullets[i];
    if(dist(b.x,b.y,player.x,player.y)<player.size){
      enemy.bullets.splice(i,1);
      player.hp-=10;
      document.getElementById("hp").textContent=player.hp;
      if(player.hp<=0){ alert("ğŸ’€ íŒ¨ë°°!"); location.reload(); }
    }
  }
}
function dist(x1,y1,x2,y2){return Math.hypot(x1-x2,y1-y2);}

// ===== ê·¸ë¦¬ê¸° =====
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle="#444";
  for(const w of walls){ ctx.fillRect(w.x,w.y,w.width,w.height); }

  ctx.fillStyle=player.color;
  ctx.beginPath(); ctx.arc(player.x,player.y,player.size,0,Math.PI*2); ctx.fill();

  if(enemy.alive){
    ctx.fillStyle=enemy.color;
    ctx.beginPath(); ctx.arc(enemy.x,enemy.y,enemy.size,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#fff";
    ctx.fillRect(enemy.x-20,enemy.y-30,40,6);
    ctx.fillStyle="#f00";
    ctx.fillRect(enemy.x-20,enemy.y-30,(enemy.hp/50)*40,6);
  }

  ctx.fillStyle="#fff"; drawBullets(player.bullets);
  ctx.fillStyle="#f77"; drawBullets(enemy.bullets);

  if(moveStick) drawStick(moveStick);
  if(fireStick) drawStick(fireStick);
}
function drawBullets(b){for(const x of b){ctx.beginPath();ctx.arc(x.x,x.y,4,0,Math.PI*2);ctx.fill();}}
function drawStick(s){
  ctx.globalAlpha=0.4;
  ctx.beginPath();ctx.arc(s.sx,s.sy,40,0,Math.PI*2);ctx.fillStyle="#888";ctx.fill();
  ctx.beginPath();ctx.arc(s.x,s.y,25,0,Math.PI*2);ctx.fillStyle="#ccc";ctx.fill();
  ctx.globalAlpha=1.0;
}

update();
</script>
</body>
</html>
