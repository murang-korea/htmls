<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>Brawl Mini</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    overflow: hidden;
    height: 100%;
    background: #1a1a1a;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  canvas {
    background: #2e2e2e;
    border-radius: 10px;
    touch-action: none;
  }
  #ui {
    position: absolute;
    top: 10px;
    left: 10px;
    color: white;
    font-family: "Pretendard", sans-serif;
    font-size: 1.1rem;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<div id="ui">‚ù§Ô∏è HP: <span id="hp">100</span></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
}
window.addEventListener("resize", resize);
resize();

// ===== Í∏∞Î≥∏ ÏÑ§Ï†ï =====
const player = { 
  x: canvas.width/2, y: canvas.height/2, 
  size: 22, color:"#4f8cff", hp:100, 
  bullets:[], canShoot:true
};
const enemy = { 
  x: canvas.width/3, y: canvas.height/3, 
  size: 22, color:"#ff4f4f", hp:50, alive:true, dirX:1, dirY:1, bullets:[]
};

let moveStick = null;
let fireStick = null;
let moveDir = {x:0,y:0};
let fireDir = {x:0,y:0};
let fireCooldown = 0;

// ===== ÌÑ∞Ïπò =====
canvas.addEventListener("touchstart", e=>{
  for(const t of e.touches){
    if(t.clientX < window.innerWidth/2){ // ÏôºÏ™Ω Ïù¥ÎèôÏä§Ìã±
      moveStick = {id:t.identifier, sx:t.clientX, sy:t.clientY, x:t.clientX, y:t.clientY};
    } else { // Ïò§Î•∏Ï™Ω Î∞úÏÇ¨Ïä§Ìã±
      fireStick = {id:t.identifier, sx:t.clientX, sy:t.clientY, x:t.clientX, y:t.clientY};
    }
  }
});

canvas.addEventListener("touchmove", e=>{
  for(const t of e.touches){
    // Ïù¥ÎèôÏä§Ìã±
    if(moveStick && t.identifier === moveStick.id){
      const dx = t.clientX - moveStick.sx;
      const dy = t.clientY - moveStick.sy;
      const dist = Math.hypot(dx,dy);
      const limit = 50;
      const ratio = dist > limit ? limit/dist : 1;
      moveStick.x = moveStick.sx + dx * ratio;
      moveStick.y = moveStick.sy + dy * ratio;
      moveDir = {x: dx/limit, y: dy/limit};
    }
    // Î∞úÏÇ¨Ïä§Ìã±
    if(fireStick && t.identifier === fireStick.id){
      const dx = t.clientX - fireStick.sx;
      const dy = t.clientY - fireStick.sy;
      const dist = Math.hypot(dx,dy);
      const limit = 50;
      const ratio = dist > limit ? limit/dist : 1;
      fireStick.x = fireStick.sx + dx * ratio;
      fireStick.y = fireStick.sy + dy * ratio;
      fireDir = {x: dx/limit, y: dy/limit};
      if(fireCooldown<=0 && dist>20){
        shoot(fireDir.x, fireDir.y);
        fireCooldown = 20; // Ïø®ÌÉÄÏûÑ ÌîÑÎ†àÏûÑ Îã®ÏúÑ (ÏïΩ 0.3Ï¥à)
      }
    }
  }
});

canvas.addEventListener("touchend", e=>{
  for(const t of e.changedTouches){
    if(moveStick && t.identifier === moveStick.id){ moveStick = null; moveDir={x:0,y:0}; }
    if(fireStick && t.identifier === fireStick.id){ fireStick = null; fireDir={x:0,y:0}; }
  }
});

function shoot(dx,dy){
  const angle = Math.atan2(dy, dx);
  player.bullets.push({
    x:player.x, y:player.y, dx:Math.cos(angle)*8, dy:Math.sin(angle)*8
  });
}

// ===== Ï†Å AI =====
setInterval(()=>{
  if(!enemy.alive) return;
  const dx = player.x - enemy.x;
  const dy = player.y - enemy.y;
  const a = Math.atan2(dy,dx);
  enemy.bullets.push({x:enemy.x,y:enemy.y,dx:Math.cos(a)*4,dy:Math.sin(a)*4});
}, 1300);

// ===== ÏóÖÎç∞Ïù¥Ìä∏ =====
function update(){
  const speed = Math.max(canvas.width,canvas.height)*0.004;
  player.x += moveDir.x * speed * 5;
  player.y += moveDir.y * speed * 5;
  fireCooldown = Math.max(0, fireCooldown-1);

  // Ï†Å Ïù¥Îèô
  if(enemy.alive){
    if(Math.random()<0.02) enemy.dirX *= -1;
    if(Math.random()<0.02) enemy.dirY *= -1;
    enemy.x += enemy.dirX * 2;
    enemy.y += enemy.dirY * 2;
  }

  handleWalls(player);
  handleWalls(enemy,true);
  moveBullets(player.bullets);
  moveBullets(enemy.bullets);
  checkHits();
  draw();
  requestAnimationFrame(update);
}

// ===== Ï∂©Îèå, Ï¥ùÏïå Îì± =====
function handleWalls(o,bounce=false){
  const minX=o.size, maxX=canvas.width-o.size, minY=o.size, maxY=canvas.height-o.size;
  if(o.x<minX){o.x=minX;if(bounce)o.dirX*=-1;}
  if(o.x>maxX){o.x=maxX;if(bounce)o.dirX*=-1;}
  if(o.y<minY){o.y=minY;if(bounce)o.dirY*=-1;}
  if(o.y>maxY){o.y=maxY;if(bounce)o.dirY*=-1;}
}
function moveBullets(bul){
  for(let i=bul.length-1;i>=0;i--){
    const b=bul[i];
    b.x+=b.dx; b.y+=b.dy;
    if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bul.splice(i,1);
  }
}
function checkHits(){
  for(let i=player.bullets.length-1;i>=0;i--){
    const b=player.bullets[i];
    if(enemy.alive && dist(b.x,b.y,enemy.x,enemy.y)<enemy.size){
      player.bullets.splice(i,1);
      enemy.hp-=10;
      if(enemy.hp<=0){
        enemy.alive=false;
        setTimeout(()=>alert("üéâ ÏäπÎ¶¨!"),100);
      }
    }
  }
  for(let i=enemy.bullets.length-1;i>=0;i--){
    const b=enemy.bullets[i];
    if(dist(b.x,b.y,player.x,player.y)<player.size){
      enemy.bullets.splice(i,1);
      player.hp-=10;
      document.getElementById("hp").textContent=player.hp;
      if(player.hp<=0){ alert("üíÄ Ìå®Î∞∞!"); location.reload(); }
    }
  }
}
function dist(x1,y1,x2,y2){return Math.hypot(x1-x2,y1-y2);}

// ===== Í∑∏Î¶¨Í∏∞ =====
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle=player.color;
  ctx.beginPath(); ctx.arc(player.x,player.y,player.size,0,Math.PI*2); ctx.fill();

  if(enemy.alive){
    ctx.fillStyle=enemy.color;
    ctx.beginPath(); ctx.arc(enemy.x,enemy.y,enemy.size,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#fff";
    ctx.fillRect(enemy.x-20,enemy.y-30,40,6);
    ctx.fillStyle="#f00";
    ctx.fillRect(enemy.x-20,enemy.y-30,(enemy.hp/50)*40,6);
  }

  ctx.fillStyle="#fff"; drawBullets(player.bullets);
  ctx.fillStyle="#f77"; drawBullets(enemy.bullets);

  // Ïù¥Îèô Ïä§Ìã±
  if(moveStick) drawStick(moveStick);
  // Î∞úÏÇ¨ Ïä§Ìã±
  if(fireStick) drawStick(fireStick);
}
function drawBullets(b){for(const x of b){ctx.beginPath();ctx.arc(x.x,x.y,4,0,Math.PI*2);ctx.fill();}}
function drawStick(s){
  ctx.globalAlpha=0.4;
  ctx.beginPath();ctx.arc(s.sx,s.sy,40,0,Math.PI*2);ctx.fillStyle="#888";ctx.fill();
  ctx.beginPath();ctx.arc(s.x,s.y,25,0,Math.PI*2);ctx.fillStyle="#ccc";ctx.fill();
  ctx.globalAlpha=1.0;
}

update();
</script>
</body>
</html>
