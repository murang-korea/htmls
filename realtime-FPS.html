<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini Brawl Fixed</title>
<style>
html, body {
  margin: 0; padding: 0; overflow: hidden;
  background: #181818; touch-action: none;
}
#gameArea {
  position: relative;
  width: 100vw; height: 100vh;
  background: radial-gradient(circle at center, #222 0%, #111 100%);
  overflow: hidden;
}
.player {
  position: absolute;
  width: 40px; height: 40px;
  border-radius: 50%;
  text-align: center; line-height: 40px;
  font-weight: bold; color: white;
}
#joystick {
  position: absolute;
  left: 40px; bottom: 40px;
  width: 120px; height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  touch-action: none;
}
#stick {
  position: absolute;
  left: 40px; top: 40px;
  width: 40px; height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.6);
}
</style>
</head>
<body>
<div id="gameArea"></div>
<div id="joystick"><div id="stick"></div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script>
const SUPABASE_URL = "https://zlhrotxaqvtedtxgvtjp.supabase.co";
const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpsaHJvdHhhcXZ0ZWR0eGd2dGpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI1MjM0MTAsImV4cCI6MjA3ODA5OTQxMH0.u5hTaGUf4NwTZ6hKO1gSpZV3SHTTbgQrTd-3ThGl0_A"; // 네 키 넣어야 함
const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

// --- 내 정보 ---
let username = "플레이어" + Math.floor(Math.random() * 9999);
let me = { username, x: window.innerWidth/2, y: window.innerHeight/2, color: randomColor() };
let others = {};

const area = document.getElementById("gameArea");
const meEl = createPlayerEl(me);

function randomColor() {
  const c = ["#ff4d4d","#4da6ff","#ffcc00","#66ff66","#ff66ff"];
  return c[Math.floor(Math.random()*c.length)];
}

function createPlayerEl(p) {
  const el = document.createElement("div");
  el.className = "player";
  el.style.background = p.color;
  el.innerText = p.username;
  area.appendChild(el);
  return el;
}

function render() {
  meEl.style.left = me.x + "px";
  meEl.style.top = me.y + "px";
  for (let id in others) {
    const o = others[id];
    if (!o.el) o.el = createPlayerEl(o);
    o.el.style.left = o.x + "px";
    o.el.style.top = o.y + "px";
  }
}

// --- 조이스틱 ---
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");
let joy = { active:false, dx:0, dy:0 };

joystick.addEventListener("touchstart", ()=> joy.active = true, {passive:true});
joystick.addEventListener("touchmove", e=>{
  const t = e.touches[0];
  const rect = joystick.getBoundingClientRect();
  const cx = rect.left + rect.width/2;
  const cy = rect.top + rect.height/2;
  const dx = t.clientX - cx;
  const dy = t.clientY - cy;
  const dist = Math.min(Math.hypot(dx, dy), 40);
  const angle = Math.atan2(dy, dx);
  stick.style.left = 40 + Math.cos(angle) * dist + "px";
  stick.style.top = 40 + Math.sin(angle) * dist + "px";
  joy.dx = Math.cos(angle);
  joy.dy = Math.sin(angle);
}, {passive:true});
joystick.addEventListener("touchend", ()=>{
  joy.active=false;
  stick.style.left="40px"; stick.style.top="40px";
  joy.dx=0; joy.dy=0;
});

// --- Supabase 동기화 ---
async function syncPlayer() {
  await sb.from("players").upsert([me]);
}

// --- Realtime 구독 ---
sb.channel("realtime:players")
  .on("postgres_changes", { event: "*", schema: "public", table: "players" }, payload => {
    const data = payload.new;
    if (data.username !== me.username) {
      others[data.username] = data;
      render();
    }
  })
  .subscribe();

// --- 위치 업데이트 루프 ---
setInterval(() => {
  me.x += joy.dx * 5;
  me.y += joy.dy * 5;
  render();
  syncPlayer();
}, 100);

// --- 초기화 ---
sb.from("players").upsert([me]);
render();
</script>
</body>
</html>
